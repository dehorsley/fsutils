#!/bin/bash
#Print the Field System log to stdout 


trap 'kill $(jobs -p)' EXIT

LOG=
PID=

while true; do
    NEW=$(lognm)

    # FS isn't running or hasn't created new log yet 
    if [ $? -ne 0 -o ! -e  "/usr2/log/${NEW}.log" ]; then
        sleep 1
        continue
    fi

    if [ "$NEW" != "$LOG" ]; then

        #Kill old tail process, disowning it so shell doesn't announce it.
        if [ -z "$PID"]; then
            disown $PID
            kill $PID
        fi

        # Only print the whole file if it's new. This avoids, e.g., printing the whole stations log when switching to it.
        if [[ $(date -r /usr2/log/${NEW}.log +%s) -gt $(date +%s --date="10 sec ago") ]]; then
            tail -n+1 -f /usr2/log/${NEW}.log & 
        else
            tail -n 0 -f /usr2/log/${NEW}.log & 
        fi
        PID=$!
        LOG=$NEW
    fi
    sleep 1
done
